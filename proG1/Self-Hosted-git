version: "3.8"

services:
  gitea:
    image: gitea/gitea:latest
    container_name: gitea
    environment:
      - USER_UID=${GITEA_UID}
      - USER_GID=${GITEA_GID}
      - GITEA__database__DB_TYPE=mysql
      - GITEA__database__HOST=gitea-db:3306
      - GITEA__database__NAME=${GITEA_DB_NAME}
      - GITEA__database__USER=${GITEA_DB_USER}
      - GITEA__database__PASSWD=${GITEA_DB_PASS}
      - GITEA__security__INSTALL_LOCK=${GITEA_INSTALL_LOCK}
      - GITEA__security__SECRET_KEY=${GITEA_SECRET_KEY}
      - GITEA__service__DISABLE_REGISTRATION=${GITEA_DISABLE_REG}
      # Optional: set ROOT_URL if behind a proxy
      - GITEA__server__ROOT_URL=${GITEA_ROOT_URL}
      # Initial admin (only used on first init; safe to keep blank afterward)
      - GITEA__admin__USERNAME=${GITEA_ADMIN_USER}
      - GITEA__admin__PASSWORD=${GITEA_ADMIN_PASS}
      - GITEA__admin__EMAIL=${GITEA_ADMIN_EMAIL}
      # Mailer
      - GITEA__mailer__ENABLED=${GITEA_MAIL_ENABLED}
      - GITEA__mailer__SMTP_ADDR=${GITEA_SMTP_ADDR}
      - GITEA__mailer__SMTP_PORT=${GITEA_SMTP_PORT}
      - GITEA__mailer__FROM=${GITEA_MAIL_FROM}
      - GITEA__mailer__PROTOCOL=${GITEA_MAIL_PROTOCOL}
      # Security
      - GITEA__security__ALLOWED_DOMAINS=${GITEA_ALLOWED_DOMAINS}
      - GITEA__security__ALLOW_LOCALNETWORKS=${GITEA_ALLOW_LOCALNETWORKS}
    volumes:
      - /opt/gitea/data:/data
    networks:
      - npm-stack_nginxproxy
    depends_on:
      gitea-db:
        condition: service_healthy
    restart: unless-stopped

  gitea-db:
    image: mysql:8
    container_name: gitea-db
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_USER=${GITEA_DB_USER}
      - MYSQL_PASSWORD=${GITEA_DB_PASS}
      - MYSQL_DATABASE=${GITEA_DB_NAME}
    volumes:
      - /opt/gitea-db/mysql-data:/var/lib/mysql
    networks:
      - npm-stack_nginxproxy
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  gitea-runner:
    image: gitea/act_runner:latest
    container_name: gitea-runner
    environment:
      - CONFIG_FILE=/config.yaml
      - GITEA_INSTANCE_URL=${GITEA_INSTANCE_URL}
      - GITEA_RUNNER_REGISTRATION_TOKEN=${GITEA_RUNNER_REGISTRATION_TOKEN}
      - GITEA_RUNNER_NAME=${GITEA_RUNNER_NAME}
      - GITEA_RUNNER_LABELS=${GITEA_RUNNER_LABELS}
    volumes:
      - /opt/gitea-runner/config.yaml:/config.yaml
      - /opt/gitea-runner/cache:/cache
      - /opt/gitea-runner/data:/data
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - npm-stack_nginxproxy
    depends_on:
      gitea:
        condition: service_started
    restart: unless-stopped

networks:
  npm-stack_nginxproxy:
    external: true

